name: CI/CD Pipeline - Self Hosted Runner

on:
  push:
    branches: [main, beta]
  pull_request:
    branches: [main, beta]
  workflow_dispatch: # Manual trigger

env:
  NODE_VERSION: '20'

jobs:
  # Quick validation on GitHub-hosted runners for fast feedback
  validate:
    name: ğŸ” Quick Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run linting
        run: npm run lint || echo "Lint not configured"

      - name: ğŸ§ª Run unit tests
        run: npm test || echo "Tests not configured"

      - name: ğŸ—ï¸ Test build
        run: npm run build

  # Main deployment on self-hosted runner
  deploy:
    name: ğŸš€ Deploy to WSL
    runs-on: [self-hosted, wsl, nestjs]
    needs: [validate]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/beta'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1

      - name: ğŸ” Environment Information
        run: |
          echo "ğŸ–¥ï¸ Runner Hostname: $(hostname)"
          echo "ğŸ‘¤ Current User: $(whoami)"
          echo "ğŸ“ Working Directory: $(pwd)"
          echo "ğŸŸ¢ Node Version: $(node --version)"
          echo "ğŸ“¦ NPM Version: $(npm --version)"
          echo "ğŸ”„ PM2 Version: $(pm2 --version)"
          echo "ğŸ’¾ Available Space: $(df -h . | tail -1 | awk '{print $4}')"
          echo "ğŸ“Š Memory Usage: $(free -h | grep '^Mem:' | awk '{print $3 "/" $2}')"

      - name: ğŸš€ Pre-deployment Tasks
        run: |
          echo "ğŸš€ Starting pre-deployment..."
          
          # Create necessary directories
          mkdir -p ~/projects/nestjs-demo
          mkdir -p ~/logs
          mkdir -p ~/backups
          
          # Stop existing application gracefully
          echo "ğŸ›‘ Stopping existing application..."
          pm2 stop nestjs-demo || echo "No existing application to stop"
          
          # Create backup of current deployment
          if [ -d ~/projects/nestjs-demo ] && [ "$(ls -A ~/projects/nestjs-demo)" ]; then
            BACKUP_DIR=~/backups/$(date +%Y%m%d_%H%M%S)
            echo "ğŸ’¾ Creating backup at $BACKUP_DIR..."
            mkdir -p $BACKUP_DIR
            cp -r ~/projects/nestjs-demo $BACKUP_DIR/ || true
            echo "âœ… Backup created successfully"
          fi
          
          echo "âœ… Pre-deployment completed"

      - name: ğŸ“ Sync Application Files
        run: |
          echo "ğŸ“ Syncing files to deployment directory..."
          
          # Sync files excluding unnecessary items
          rsync -av --delete \
            --exclude='.git/' \
            --exclude='node_modules/' \
            --exclude='.github/' \
            --exclude='*.md' \
            --exclude='.env*' \
            --exclude='tmp_*' \
            --exclude='coverage/' \
            --exclude='dist/' \
            ./ ~/projects/nestjs-demo/
          
          echo "âœ… Files synced successfully"

      - name: ğŸ“¦ Install Dependencies
        working-directory: /home/runner/projects/nestjs-demo
        run: |
          echo "ğŸ“¦ Installing production dependencies..."
          
          # Clean install for production
          npm ci --omit=dev --silent
          
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ—ï¸ Build Application
        working-directory: /home/runner/projects/nestjs-demo
        run: |
          echo "ğŸ—ï¸ Building application..."
          
          # Build the application
          npm run build
          
          # Verify build output
          if [ ! -d "dist" ] || [ ! -f "dist/main.js" ]; then
            echo "âŒ Build failed - dist/main.js not found"
            exit 1
          fi
          
          echo "âœ… Application built successfully"

      - name: âš™ï¸ Configure Environment
        working-directory: /home/runner/projects/nestjs-demo
        run: |
          echo "âš™ï¸ Setting up environment configuration..."
          
          # Create production environment file
          cat > .env.production << EOF
          NODE_ENV=production
          PORT=3000
          # Add your production variables here
          EOF
          
          # Set proper permissions
          chmod 600 .env.production
          
          echo "âœ… Environment configured"

      - name: ğŸš€ Deploy Application
        working-directory: /home/runner/projects/nestjs-demo
        run: |
          echo "ğŸš€ Deploying application with PM2..."
          
          # Create PM2 ecosystem config if not exists
          if [ ! -f "ecosystem.config.js" ]; then
            cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'nestjs-demo',
              script: 'dist/main.js',
              env: {
                NODE_ENV: 'development'
              },
              env_production: {
                NODE_ENV: 'production',
                PORT: 3000
              },
              instances: 1,
              exec_mode: 'fork',
              max_memory_restart: '300M',
              error_file: '~/logs/nestjs-demo-error.log',
              out_file: '~/logs/nestjs-demo-out.log',
              log_file: '~/logs/nestjs-demo.log',
              time: true,
              autorestart: true,
              watch: false,
              ignore_watch: ["node_modules", "logs"],
              env_file: '.env.production'
            }]
          }
          EOF
          fi
          
          # Deploy with PM2
          pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
          
          # Save PM2 process list
          pm2 save
          
          echo "âœ… Application deployed successfully"

      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Performing application health check..."
          
          # Wait for application to start
          echo "â³ Waiting for application to start..."
          sleep 15
          
          # Health check with retries
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "ğŸ” Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            if curl -s -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… Health check passed! Application is running."
              
              # Additional checks
              echo "ğŸ“Š Application status:"
              pm2 show nestjs-demo || true
              
              exit 0
            elif curl -s -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… Application is responding (no /health endpoint)"
              exit 0
            else
              echo "â³ Attempt $ATTEMPT failed, retrying in 10s..."
              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
          
          echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
          echo "ğŸ“‹ PM2 Status:"
          pm2 list
          echo "ğŸ“ Recent logs:"
          pm2 logs nestjs-demo --lines 20 --nostream || true
          
          exit 1

      - name: ğŸ§¹ Post-deployment Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Running cleanup tasks..."
          
          # Clean old backups (keep last 5)
          if [ -d ~/backups ]; then
            echo "ğŸ—‚ï¸ Cleaning old backups..."
            find ~/backups -maxdepth 1 -type d -name "20*" | sort | head -n -5 | xargs rm -rf || true
          fi
          
          # Clean npm cache
          echo "ğŸ§½ Cleaning npm cache..."
          npm cache clean --force || true
          
          # Flush old PM2 logs
          echo "ğŸ“ Flushing old PM2 logs..."
          pm2 flush || true
          
          echo "âœ… Cleanup completed"

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "===================="
          echo "ğŸ”— Commit SHA: ${{ github.sha }}"
          echo "ğŸ“ Commit Message: $(git log -1 --pretty=%B)"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ• Deployment Time: $(date)"
          echo "ğŸ·ï¸ Event: ${{ github.event_name }}"
          
          echo ""
          echo "ğŸš€ Application Details:"
          echo "ğŸ“ URL: http://localhost:3000"
          echo "ğŸ” Health Check: http://localhost:3000/health"
          
          echo ""
          echo "ğŸ“‹ PM2 Process Status:"
          pm2 list || true
          
          echo ""
          echo "ğŸ’¾ System Resources:"
          echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)%"
          echo "Memory: $(free | grep Mem | awk '{printf("%.1f%%", $3/$2 * 100.0)}')"
          echo "Disk: $(df -h / | awk 'NR==2{printf "%s", $5}')"

  # Notification job (optional)
  notify:
    name: ğŸ“¬ Notify Deployment
    runs-on: [self-hosted, wsl, nestjs]
    needs: [deploy]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/beta')
    
    steps:
      - name: ğŸ“¬ Send Notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ Deployment Successful!"
            echo "âœ… NestJS application deployed to WSL"
            echo "ğŸŒ Available at: http://localhost:3000"
          else
            echo "âŒ Deployment Failed!"
            echo "ğŸ” Check the deployment logs for details"
            echo "ğŸ“‹ PM2 Status:"
            pm2 list || true
          fi